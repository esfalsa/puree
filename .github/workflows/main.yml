name: Find Detags
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:
jobs:
  find-detags:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Save Date
        run: |
          echo "YEAR=$(date --date="yesterday" +"%Y")" >> ${GITHUB_ENV}
          echo "MONTH=$(date --date="yesterday" +"%m")" >> ${GITHUB_ENV}
          echo "DAY=$(date --date="yesterday" +"%d")" >> ${GITHUB_ENV}
          echo "DATE=$(date --date="yesterday" +"%Y-%m-%d")" >> ${GITHUB_ENV}
          echo "DATEPATH=$(date --date="yesterday" +"%Y/%m/%d")" >> ${GITHUB_ENV}

      - name: Create Output Directories
        run: |
          [[ -d "$YEAR" ]] || mkdir "$YEAR"
          [[ -d "$YEAR/$MONTH" ]] || mkdir "$YEAR/$MONTH"
          [[ -d "$YEAR/$MONTH/$DAY" ]] || mkdir "$YEAR/$MONTH/$DAY"

      - name: Download Daily Dump
        run: curl -A "Purée by Esfalsa (esfalsa.github.io)" https://www.nationstates.net/pages/regions.xml.gz --output "$DATEPATH/regions.xml.gz"

      - name: Unzip Daily Dump
        run: gzip -d "$DATEPATH/regions.xml.gz"

      - name: Copy Daily Dump
        run: cp -f "$DATEPATH/regions.xml" "regions.xml"

      - name: Get Passworded Regions
        run: curl -A "Purée by Esfalsa (esfalsa.github.io)" https://www.nationstates.net/cgi-bin/api.cgi\?q\=regionsbytag\;tags\=password --output "passworded.xml"

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
      
      - name: Run Detag Finder
        run: python main.py
      
      - name: Record Update Time
        run: |
          echo "$(date)" > _includes/lastupdate.html
          echo $DATE > _includes/lastdump.html

      - name: Commit Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Purée ${{ env.DATE }}